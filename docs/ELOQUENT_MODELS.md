# Tài liệu Eloquent Models (SimbaSql)\n\n## Giới thiệu\n\nTài liệu này mô tả về các Eloquent Models đã được tạo trong package `diepxuan/laravel-simba` để ánh xạ tới các bảng dữ liệu trong cơ sở dữ liệu SimbaSql. Các models này cung cấp một cách làm việc với dữ liệu Simba một cách trực quan và an toàn trong môi trường Laravel.\n\n## Tổng quan\n\n- **Số lượng Eloquent Models đã tạo**: Hơn **440** models.\n- **Mục đích**: Cung cấp giao diện Object-Oriented để truy vấn, thao tác dữ liệu trên các bảng SimbaSql.\n- **Namespace**: `Diepxuan\\Simba\\SModel\\` và `Diepxuan\\Simba\\Models\\`.\n- **Cơ sở dữ liệu gốc**: SimbaSql (SQL Server).\n- **Thư mục chứa code Models**: `diepxuan/laravel-simba/src/SModel/` và `diepxuan/laravel-simba/src/Models/`.\n\n## Cấu trúc Models\n\n### 1. `src/SModel/` - Models chính ánh xạ trực tiếp đến bảng Simba\n\n- Các class trong thư mục này là bản sao trực tiếp của các bảng trong SimbaSql.\n- Chúng sử dụng Trait `HasCompositePrimaryKey` từ `Diepxuan\\LaravelEloquentComposite` để hỗ trợ các khóa chính phức tạp.\n- Tên class model thường là tên bảng hoặc dạng rút gọn của tên bảng.\n\n**Ví dụ một số Model chính và bảng tương ứng:**\n\n| Class Model | Bảng SimbaSql | Mô tả |\n|-------------|---------------|-------|\n| **SysLanguage** | `SysLanguage` | Danh mục ngôn ngữ |\n| **InCT3** | `InCT3` | Chứng từ kho chi tiết |\n| **SoPh3** | `SoPh3` | Tổng hợp phiếu bán hàng |\n| **GlDmTk** | `GlDmTk` | Danh mục tài khoản kế toán |\n| **GlCt** | `GlCt` | Chi tiết chứng từ kế toán |\n| **GlCdTk** | `GlCdTk` | Số dư đầu kỳ tài khoản |\n| **SysCompany** | `SysCompany` | Thông tin công ty |\n| **SysCompanyResx** | `SysCompanyResx` | Tài nguyên công ty |\n| **InDmVt** | `InDmVt` | Danh mục vật tư |\n| **InPH3** | `InPH3` | Tổng hợp chứng từ kho |\n| **SiSetup** | `SiSetup` | Thiết lập hệ thống |\n| **SysUserCompanyRight** | `SysUserCompanyRight` | Quyền người dùng theo công ty |\n| **ArDmKh** | `ArDmKh` | Danh mục khách hàng/NCC/NV |\n| **InDmKho** | `InDmKho` | Danh mục kho |\n| **SysUserInfo** | `SysUserInfo` | Thông tin người dùng hệ thống |\n| **InDmNhvt** | `InDmNhvt` | Danh mục nhóm vật tư |\n\n*Danh sách đầy đủ có thể xem trong `diepxuan/laravel-simba/src/SModel/`*\n\n### 2. `src/Models/` - Models mở rộng (Customization)\n\n- Thư mục này chứa các models được tùy chỉnh hoặc mở rộng từ các model trong `SModel/`.\n- Mục đích là thêm các scope, method tùy chỉnh, hoặc định nghĩa quan hệ (relationships) phức tạp hơn mà không ảnh hưởng đến ánh xạ cơ bản.\n\n**Ví dụ:**\n- `SysCompany.php`: Có thể thêm các scope hoặc method liên quan đến công ty.\n- `SysUserCompanyRight.php`: Có thể thêm các scope để lọc quyền.\n\n*Lưu ý: Khi cần sử dụng, ưu tiên dùng model trong `src/Models/` nếu có, ngược lại dùng model trong `src/SModel/`.* \n\n## Đặc điểm chung của Models\n\n- **Composite Primary Keys**: Sử dụng Trait `HasCompositePrimaryKey` để định nghĩa khóa chính gồm nhiều cột.\n  ```php\n  // Ví dụ trong SysUserCompanyRight.php\n  use Diepxuan\\LaravelEloquentComposite\\HasCompositePrimaryKey;\n  \n  class SysUserCompanyRight extends SModel\SysUserCompanyRight {\n      use HasCompositePrimaryKey;\n  \n      // Định nghĩa các cột trong khóa chính\n      protected $primaryKey = ['user_id', 'ma_cty'];\n      // ...\n  }\n  ```\n- **Table Names**: Tên bảng được định nghĩa rõ ràng.\n  ```php\n  protected $table = 'ArDmKh'; // Ánh xạ tới bảng ArDmKh\n  ```\n- **Column Definitions**: Các kiểu dữ liệu cột được Laravel tự động suy luận hoặc có thể định nghĩa rõ ràng.\n- **Timestamps**: Thông thường, các models này không sử dụng `timestamps` mặc định của Laravel (`created_at`, `updated_at`) vì SimbaSql đã có các cột audit riêng (`cdate`, `ldate`).\n- **Mass Assignment**: Sử dụng `$fillable` hoặc `$guarded` để kiểm soát việc gán thuộc tính hàng loạt.\n- **Data Integrity**: Các validation được thực hiện chủ yếu ở tầng database (stored procedures), nhưng có thể bổ sung validation ở tầng model.\n\n## Các thành phần liên quan\n\n- **`diepxuan/laravel-eloquent-composite`**: Package cung cấp Trait `HasCompositePrimaryKey`.\n- **`diepxuan/laravel-simba/src/StoredProcedures/`**: Các lớp gọi Stored Procedures, thường làm việc với các Models này.\n- **`diepxuan/php-charset`**: Đảm bảo xử lý đúng ký tự tiếng Việt.\n\n## Hướng dẫn sử dụng\n\n### 1. Lấy dữ liệu\n\n```php\nuse Diepxuan\\Simba\\SModel\\GlDmTk; // Hoặc Diepxuan\\Simba\\Models\\GlDmTk nếu có model mở rộng\n\n// Lấy tất cả tài khoản\n$accounts = GlDmTk::all();\n\n// Lấy tài khoản theo mã công ty và mã tài khoản\n$account = GlDmTk::where('ma_cty', '001')\n                   ->where('tk', '1111')\n                   ->first();\n\n// Sử dụng scope (nếu có)\n$glAccounts = GlDmTk::gl()->get(); // Ví dụ scope 'gl'\n```\n\n### 2. Thêm mới dữ liệu\n\n```php\nuse Diepxuan\\Simba\\SModel\\ArDmKh;\n\n$customer = new ArDmKh();\n$customer->ma_cty = '001';\n$customer->ma_kh = 'KH001';\n$customer->ten_kh = 'Công ty ABC';\n$customer->isKh = 1; // Là khách hàng\n$customer->save();\n```\n\n### 3. Cập nhật dữ liệu\n\n```php\n$customer = ArDmKh::find('KH001'); // Giả định khóa chính chỉ là ma_kh cho ví dụ này\nif ($customer) {\n    $customer->dia_chi = '123 Đường ABC';\n    $customer->save();\n}\n```\n\n### 4. Xóa dữ liệu\n\n```php\n$customer = ArDmKh::where('ma_cty', '001')->where('ma_kh', 'KH001')->first();\nif ($customer) {\n    $customer->delete();\n}\n```\n\n## Lưu ý quan trọng\n\n- **Khóa chính Composite**: Luôn kiểm tra định nghĩa `primaryKey` và sử dụng đúng cách khi tìm kiếm hoặc cập nhật.\n- **Data Integrity**: Các validation mạnh mẽ nằm ở Stored Procedures. Model nên có thêm validation ở tầng ứng dụng để bắt lỗi sớm.\n- **Quan hệ (Relationships)**: Các quan hệ (ví dụ: `hasMany`, `belongsTo`) có thể được định nghĩa thêm trong các Models mở rộng (`src/Models/`) để tiện truy vấn.\n- **Performance**: Với các bảng lớn, nên sử dụng các phương thức query builder hiệu quả và các index phù hợp.\n\n## Tài liệu liên quan\n\n- [OVERVIEW.md](./OVERVIEW.md) - Tổng quan dự án và mối quan hệ Portal - SimbaSql.\n- [DATABASE_SCHEMA.md](./DATABASE_SCHEMA.md) - Cấu trúc database SimbaSql.\n- [STORED_PROCEDURES.md](./STORED_PROCEDURES.md) - Tài liệu Stored Procedures.\n- [INTEGRATION_GUIDE.md](./INTEGRATION_GUIDE.md) - Hướng dẫn tích hợp.\n- [AI_AGENT_REFERENCE.md](./AI_AGENT_REFERENCE.md) - Tài liệu tham khảo cho AI Agent.\n\n---\n*Tài liệu được cập nhật lần cuối: 2026-02-13*